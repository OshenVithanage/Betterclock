<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BetterClock â€“ Timers</title>
    <style>
        :root {
            --bg: #0b0b0c;
            --panel: #141416;
            --muted: #8b8d92;
            --text: #e9eaed;
            --primary: #1a73e8;
            --primary-weak: #1a73e81a;
            --ring-bg: #2a2c30;
        }
        html, body {
            height: 100%;
        }
        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            display: grid;
            place-items: center;
        }
        .app {
            width: min(920px, 92vw);
            padding: 32px;
        }
        .tabs {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-bottom: 24px;
        }
        .tab {
            padding: 8px 14px;
            border-radius: 999px;
            background: #1b1c20;
            color: var(--muted);
            font-weight: 600;
            user-select: none;
        }
        .tab.active { background: #2a2b30; color: var(--text); }
        .timer-card {
            background: var(--panel);
            border-radius: 20px;
            padding: 28px;
            display: grid;
            place-items: center;
            box-shadow: 0 10px 40px #0006;
        }
        .ring {
            width: 420px; height: 420px; position: relative;
        }
        canvas { width: 100%; height: 100%; display: block; }
        .time {
            position: absolute; inset: 0; display: grid; place-items: center;
            font-size: 92px; font-weight: 600; letter-spacing: 1px;
        }
        .preset-row {
            margin-top: 18px; display: flex; gap: 8px; justify-content: center;
        }
        .chip { background: #222329; color: var(--text); border: 1px solid #2f3137; padding: 8px 12px; border-radius: 12px; cursor: pointer; }
        .chip[aria-pressed="true"] { outline: 2px solid var(--primary); background: #1b2130; }
        .controls { margin-top: 28px; display: flex; gap: 12px; justify-content: center; }
        .btn { border: 0; padding: 12px 22px; border-radius: 12px; font-weight: 700; cursor: pointer; }
        .btn.primary { background: var(--primary); color: white; }
        .btn.ghost { background: #23252a; color: var(--text); }
        .footer-note { margin-top: 12px; color: var(--muted); font-size: 12px; text-align: center; }
        .row { display: flex; gap: 12px; align-items: center; justify-content: center; margin-top: 10px; color: var(--muted) }
        select, input[type="number"] { background: #1b1d22; color: var(--text); border: 1px solid #2b2e35; padding: 8px 10px; border-radius: 10px; }
        input[type="number"] { width: 90px; text-align: center; }
    </style>
</head>
<body>
    <div class="app">
        <div class="tabs">
            <div class="tab">World Clock</div>
            <div class="tab">Alarms</div>
            <div class="tab">Stopwatch</div>
            <div class="tab active">Timers</div>
        </div>
        <div class="timer-card">
            <div class="ring">
                <canvas id="ringCanvas" width="420" height="420"></canvas>
                <div class="time" id="timeText">00:00</div>
            </div>
            <div class="row">
                <span>Timer</span>
                <select id="styleSelect">
                    <option value="radial">Radial (Default)</option>
                </select>
                <input id="minutesInput" type="number" min="0" max="999" value="15" />
                <span class="footer-note">minutes</span>
            </div>
            <div class="preset-row">
                <button class="chip" data-min="5">5</button>
                <button class="chip" data-min="10">10</button>
                <button class="chip" data-min="15">15</button>
                <button class="chip" data-min="25">25</button>
                <button class="chip" data-min="45">45</button>
            </div>
            <div class="controls">
                <button id="cancelBtn" class="btn ghost">Cancel</button>
                <button id="mainBtn" class="btn primary">Start</button>
            </div>
            <div class="footer-note" id="statusNote">Ready</div>
        </div>
    </div>
    <script>
        const canvas = document.getElementById('ringCanvas');
        const ctx = canvas.getContext('2d');
        const timeText = document.getElementById('timeText');
        const mainBtn = document.getElementById('mainBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const minutesInput = document.getElementById('minutesInput');
        const statusNote = document.getElementById('statusNote');

        const R = 200; // radius
        const LINE = 10;
        let totalMs = 0;
        let remainingMs = 0;
        let state = 'idle'; // idle | running | paused | finished
        let rafId = null;
        let lastTs = 0;

        function drawRing(progress) {
            const cx = canvas.width / 2; const cy = canvas.height / 2;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // track
            ctx.beginPath();
            ctx.arc(cx, cy, R, 0, Math.PI * 2);
            ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--ring-bg');
            ctx.lineWidth = LINE;
            ctx.stroke();
            // progress
            ctx.beginPath();
            const start = -Math.PI/2; // top
            ctx.arc(cx, cy, R, start, start + Math.PI * 2 * progress);
            ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--primary');
            ctx.lineCap = 'round';
            ctx.lineWidth = LINE + 2;
            ctx.stroke();
        }

        function mmss(ms) {
            const s = Math.max(0, Math.floor(ms/1000));
            const m = Math.floor(s/60);
            const r = s % 60;
            return `${String(m).padStart(2,'0')}:${String(r).padStart(2,'0')}`;
        }

        function updateUI() {
            timeText.textContent = mmss(remainingMs);
            const p = totalMs === 0 ? 0 : (totalMs - remainingMs) / totalMs;
            drawRing(p);
            if (state === 'idle' || state === 'finished') { mainBtn.textContent = 'Start'; }
            else if (state === 'running') { mainBtn.textContent = 'Pause'; }
            else if (state === 'paused') { mainBtn.textContent = 'Resume'; }
            statusNote.textContent = state === 'running' ? 'Timer running' : state === 'paused' ? 'Paused' : 'Ready';
            if (window.electronAPI?.timerTick) {
                window.electronAPI.timerTick({
                    state,
                    remaining: Math.max(0, remainingMs),
                    total: totalMs
                });
            }
        }

        function loop(ts) {
            if (state !== 'running') return;
            if (!lastTs) lastTs = ts;
            const dt = ts - lastTs;
            lastTs = ts;
            remainingMs -= dt;
            if (remainingMs <= 0) {
                remainingMs = 0;
                state = 'finished';
                updateUI();
                window.electronAPI?.timerDone?.();
                return;
            }
            updateUI();
            rafId = requestAnimationFrame(loop);
        }

        function startTimer() {
            const mins = Math.max(0, Number(minutesInput.value || 0));
            totalMs = mins * 60 * 1000;
            remainingMs = totalMs;
            state = 'running';
            lastTs = 0;
            cancelAnimationFrame(rafId);
            updateUI();
            rafId = requestAnimationFrame(loop);
        }

        function pauseOrResume() {
            if (state === 'running') {
                state = 'paused';
                cancelAnimationFrame(rafId);
                updateUI();
            } else if (state === 'paused') {
                state = 'running';
                lastTs = 0;
                updateUI();
                rafId = requestAnimationFrame(loop);
            } else if (state === 'idle' || state === 'finished') {
                startTimer();
            }
        }

        function cancelTimer() {
            state = 'idle';
            cancelAnimationFrame(rafId);
            remainingMs = 0; totalMs = 0; lastTs = 0;
            updateUI();
            window.electronAPI?.timerCanceled?.();
        }

        // Controls
        mainBtn.addEventListener('click', () => {
            if (state === 'idle' || state === 'finished') startTimer(); else pauseOrResume();
        });
        cancelBtn.addEventListener('click', () => cancelTimer());
        document.querySelectorAll('.chip').forEach(el => el.addEventListener('click', () => {
            minutesInput.value = el.getAttribute('data-min');
            document.querySelectorAll('.chip').forEach(c => c.setAttribute('aria-pressed','false'));
            el.setAttribute('aria-pressed','true');
        }));

        // Tray menu actions from main process
        window.electronAPI?.onTrayAction?.((_, action) => {
            if (action === 'toggle') { pauseOrResume(); }
            else if (action === 'cancel') { cancelTimer(); }
            else if (action === 'start') { if (state === 'idle') startTimer(); }
        });

        // Initial UI
        remainingMs = 0; totalMs = 0; updateUI();
    </script>
</body>
</html>